#!/bin/sh

echo "";
if [ -n "$(git status --porcelain)" ]; then
  echo "${green}âœ“${reset} There are changes";
	if [ -n "$(git diff --name-only --cached)" ]; then
		echo "${green}âœ“${reset} And they are staged";
	else
		echo "${red}Ã—${reset} But they are not staged";
		exit 1;
	fi
else
  echo "${red}Ã—${reset} There are no changes";
	exit 1;
fi
echo "";

if [[ $# -lt 1 ]]; then
	echo "${red}Please provide a commit message${reset}";
	exit;
fi

packageJsonPath="package.json"
if [ -d "./scheduler.frontend.ng2" ]; then
    packageJsonPath="scheduler.frontend.ng2/package.json"
fi

# If environment var GIT_ICON_ARRAY is not set
# Get fallback
if [ -z "$GIT_ICON_ARRAY" ];
then GIT_ICON_ARRAY=(
	"â™»ï¸  refac.|lint|docs|no logic "
	"ðŸ’… ui"
	"ðŸ¥’ tests"
	"ðŸ› bugfix"
	"âœ¨ feature"
	"ðŸ§¹ cleanup"
	"ðŸ’¬ text|i18n"
	"âš¡ï¸ performance"
	"ðŸ“¦ npm; node"
	"ðŸ”§ scripts|config"
	# NOTE: More of them here: gitmoji --list
); fi

function getEmojiByKey() {
	if [[ $1 == '-' ]]; then
		echo ''
	else
		echo $1
	fi
}

bugsUrl="$(jq -r .bugs.url "$packageJsonPath")"
atlassianUrlFromBugsUrl=$(echo $bugsUrl | grep -o 'atlassian\.net')
if [ -n "$atlassianUrlFromBugsUrl" ]; then
	echo "${orange}Ticket NR?${reset} `echo $'\n'`";
	PS3='Please enter your choice: '
	read TICKET_NR
	echo
fi

echo "${orange}What kind of commit is this?${reset} `echo $'\n'`";
PS3='Please enter your choice: '
select opt in "${GIT_ICON_ARRAY[@]}"
do
	EMOJI=$(getEmojiByKey $opt)
	echo $SELECTED_EMOJI
	break
done

if [[ $TICKET_NR ]]; then
	COMMIT_MESSAGE="$TICKET_NR $EMOJI $@"
else
	COMMIT_MESSAGE="$EMOJI $@"
fi

echo '=>> git commit -m "'$COMMIT_MESSAGE'"';
git commit -m "$COMMIT_MESSAGE";
